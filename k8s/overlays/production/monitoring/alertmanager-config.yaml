apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-opryxx
  namespace: monitoring
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      # Resolve timeout is the time after which an alert is declared resolved
      resolve_timeout: 5m
      
      # Default SMTP configuration
      smtp_smarthost: 'smtp.example.com:587'
      smtp_from: 'alertmanager@opryxx.com'
      smtp_auth_username: 'alertmanager'
      smtp_auth_password: '${SMTP_PASSWORD}'
      smtp_require_tls: true
      
      # Slack API URL for notifications
      slack_api_url: '${SLACK_API_URL}'
      
      # PagerDuty integration key
      pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'
      
      # OpsGenie API key
      opsgenie_api_key: '${OPSGENIE_API_KEY}'
      
      # Default HTTP client config
      http_config: {}
      
      # Default templates
      templates:
        - '/etc/alertmanager/template/*.tmpl'
    
    # Route tree configuration
    route:
      # Default receiver
      receiver: 'slack-notifications'
      
      # Group by alert labels
      group_by: ['alertname', 'severity', 'service']
      
      # Default group wait, group interval, and repeat interval
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 6h
      
      # Default routes
      routes:
        # Critical alerts go to pagerduty
        - match:
            severity: critical
          receiver: 'pagerduty'
          continue: true
          
        # Warning alerts go to slack
        - match:
            severity: warning
          receiver: 'slack-notifications'
          continue: true
          
        # Database related alerts go to DBA team
        - match:
            team: dba
          receiver: 'dba-team'
          continue: true
          
        # All other alerts go to default receiver
        - receiver: 'slack-notifications'
    
    # Receiver configurations
    receivers:
      # Default receiver (Slack)
      - name: 'slack-notifications'
        slack_configs:
          - channel: '#alerts-opryxx'
            send_resolved: true
            title: '{{ template "slack.opryxx.title" . }}'
            text: '{{ template "slack.opryxx.text" . }}'
            icon_emoji: '{{ template "slack.opryxx.icon_emoji" . }}'
            color: '{{ template "slack.opryxx.color" . }}'
            title_link: '{{ template "slack.opryxx.title_link" . }}'
            
      # PagerDuty receiver for critical alerts
      - name: 'pagerduty'
        pagerduty_configs:
          - routing_key: '${PAGERDUTY_ROUTING_KEY}'
            description: '{{ .CommonAnnotations.summary }}'
            details:
              firing: '{{ template "pagerduty.opryxx.instances" .Alerts.Firing }}'
              num_firing: '{{ .Alerts.Firing | len }}'
              num_resolved: '{{ .Alerts.Resolved | len }}'
              resolved: '{{ template "pagerduty.opryxx.instances" .Alerts.Resolved }}'
            send_resolved: true
            severity: '{{ .CommonLabels.severity }}'
            class: '{{ .CommonLabels.alertname }}'
            component: '{{ .CommonLabels.job }}'
            group: '{{ .CommonLabels.team }}'
            
      # Email receiver for DBA team
      - name: 'dba-team'
        email_configs:
          - to: 'dba-team@opryxx.com'
            send_resolved: true
            headers:
              subject: '{{ template "email.opryxx.subject" . }}'
            html: '{{ template "email.opryxx.html" . }}'
            
      # Webhook receiver for custom integrations
      - name: 'webhook'
        webhook_configs:
          - url: 'http://webhook-receiver:5001/'
            send_resolved: true
            
    # Inhibit rules
    inhibit_rules:
      # Don't alert on warning if there's already a critical alert for the same alertname
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'instance']
        
      # Don't alert on pod level issues if the node is down
      - source_match:
          alertname: 'NodeDown'
          severity: 'critical'
        target_match:
          severity: 'critical'
        equal: ['node']
        
      # Don't alert on pod level issues if the namespace is being deleted
      - source_match:
          alertname: 'KubePodNotReady'
          namespace: 'opryxx-production'
        target_match:
          namespace: 'opryxx-production'
        equal: ['alertname']
    
    # Templates for notifications
    templates:
      - '/etc/alertmanager/templates/*.tmpl'
