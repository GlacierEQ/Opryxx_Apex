apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: opryxx-hpa
  annotations:
    description: "HPA configuration for OPRYXX production workload"
spec:
  # Target reference to scale
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: opryxx
  
  # Minimum and maximum number of replicas
  minReplicas: 3
  maxReplicas: 20
  
  # Metrics to scale on
  metrics:
    # Target CPU utilization across all pods
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
    
    # Target memory utilization across all pods
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 70
    
    # Custom metric - requests per second
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: 500
    
    # Custom metric - request latency
    - type: Pods
      pods:
        metric:
          name: http_request_duration_seconds
        target:
          type: AverageValue
          averageValue: 0.5
  
  # Scaling behavior configuration
  behavior:
    # Scale down slowly to avoid flapping
    scaleDown:
      stabilizationWindowSeconds: 300  # 5 minutes
      policies:
      - type: Percent
        value: 10  # Maximum 10% of current replicas can be scaled down per minute
        periodSeconds: 60
      - type: Pods
        value: 1  # But never scale down more than 1 pod at a time
        periodSeconds: 60
      selectPolicy: Min  # Use the most restrictive policy
    
    # Scale up quickly to handle traffic spikes
    scaleUp:
      stabilizationWindowSeconds: 60  # 1 minute
      policies:
      - type: Percent
        value: 50  # Scale up by 50% of current replicas
        periodSeconds: 60
      - type: Pods
        value: 5  # But no more than 5 pods at a time
        periodSeconds: 60
      selectPolicy: Max  # Use the most permissive policy
