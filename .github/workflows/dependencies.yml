name: Dependencies

on:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday
  workflow_dispatch:
    inputs:
      dependency-type:
        description: 'Type of dependency to update'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - python
        - node
        - actions

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools safety
    
    - name: Update Python dependencies
      if: ${{ github.event.inputs.dependency-type == 'all' || github.event.inputs.dependency-type == 'python' }}
      run: |
        # Update requirements
        pip-compile --upgrade --output-file requirements.txt pyproject.toml || true
        pip-compile --upgrade --output-file requirements-dev.txt requirements-dev.in || true
        
        # Check for updates
        echo "Outdated packages:"
        pip list --outdated || echo "Failed to check for outdated packages"
        
    - name: Check for security vulnerabilities
      run: |
        echo "Checking for security vulnerabilities..."
        pip freeze | safety check --json > safety-report.json || echo "Safety check failed"
        
    - name: Create Pull Request for Python updates
      if: github.event_name != 'pull_request'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN || github.token }}
        commit-message: "chore(deps): update Python dependencies"
        title: "Update Python Dependencies"
        body: |
          Automated update of Python dependencies
          
          This PR was automatically generated by the Dependencies workflow.
        branch: "deps/update-python-$(date +%s)"
        delete-branch: true
        
    - name: Run Dependabot Security Updates
      if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.dependency-type == 'all' || github.event.inputs.dependency-type == 'actions') }}
      run: |
        echo "Dependabot security updates would run here"
        # Note: Dependabot is configured via dependabot.yml and runs separately
        
    - name: Check for vulnerabilities with Snyk
      if: ${{ github.event_name == 'workflow_dispatch' && secrets.SNYK_TOKEN != '' }}
      uses: snyk/actions/python-3.10@master
      continue-on-error: true
      with:
        args: --severity-threshold=high
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN || 'dummy-token' }}
        
    - name: Generate SBOM
      run: |
        echo "SBOM generation would run here"
        # Alternative: Use pip-licenses or pip-requirements-parser to generate SBOM
        # pip install pip-licenses
        # pip-licenses --format=json --with-license-file --with-urls --with-description --output-file sbom.json
        
    - name: Upload scan results
      uses: actions/upload-artifact@v3
      with:
        name: dependency-scan-results
        path: |
          safety-report.json
          # sbom.json if generated
        retention-days: 7
