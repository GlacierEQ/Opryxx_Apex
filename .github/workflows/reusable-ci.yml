name: Reusable CI Pipeline

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: '3.11'
      node-version:
        required: false
        type: string
        default: '18'
      run-tests:
        required: false
        type: boolean
        default: true
      run-security-scan:
        required: false
        type: boolean
        default: true
      run-performance-tests:
        required: false
        type: boolean
        default: false

jobs:
  test:
    runs-on: ubuntu-latest
    if: inputs.run-tests
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov flake8 black isort
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Lint with flake8
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - name: Format check with black
      run: black --check .
    - name: Import sort check
      run: isort --check-only .
    - name: Test with pytest
      run: pytest --cov=. --cov-report=xml
    - name: Upload coverage
      uses: codecov/codecov-action@v3

  security:
    runs-on: ubuntu-latest
    if: inputs.run-security-scan
    steps:
    - uses: actions/checkout@v4
    - name: Run Bandit Security Scan
      uses: securecodewarrior/github-action-bandit@v1
      with:
        config_file: .bandit
    - name: Run Safety Check
      run: |
        pip install safety
        safety check

  performance:
    runs-on: ubuntu-latest
    if: inputs.run-performance-tests
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Run performance tests
      run: python -m pytest tests/test_performance*.py -v